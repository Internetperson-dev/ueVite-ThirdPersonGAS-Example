name: UE4 Optimized Build (Windows)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      buildConfig:
        description: Build Configuration
        required: true
        default: Development
        type: choice
        options: [Development, Shipping]

jobs:
  build:
    runs-on: windows-2019

    env:
      UE_ROOT: X:\Engine
      PROJECT_DIR: ${{ github.workspace }}\project
      UPROJECT: ${{ github.workspace }}\project\ActionRPG - Vite\ActionRPG.uproject
      OUTPUT_DIR: ${{ github.workspace }}\project\release

    steps:
    # -------------------------------------------------
    # Enable Long Paths
    # -------------------------------------------------
    - name: Enable long paths
      shell: powershell
      run: |
        New-ItemProperty `
          -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" `
          -Name "LongPathsEnabled" `
          -Value 1 `
          -PropertyType DWORD `
          -Force
        git config --system core.longpaths true

    # -------------------------------------------------
    # Install REQUIRED Legacy Dependencies (CRITICAL)
    # -------------------------------------------------
    - name: Install Unreal legacy dependencies
      shell: powershell
      run: |
        choco install vcredist-all -y
        choco install windows-sdk-10-version-1903-all -y
        choco install dotnetfx --version=4.6.2 -y

    # -------------------------------------------------
    # Checkout UE4 Source
    # -------------------------------------------------
    - name: Checkout UE4 Engine
      uses: actions/checkout@v4
      with:
        repository: GapingPixel/UnrealEngineVite-PhysX
        path: ue
        lfs: true
        token: ${{ secrets.UE_PAT }}

    # -------------------------------------------------
    # Map UE to X:
    # -------------------------------------------------
    - name: Map UE to X drive
      shell: cmd
      run: |
        subst X: "%GITHUB_WORKSPACE%\ue"

    # -------------------------------------------------
    # Cache GitDependencies
    # -------------------------------------------------
    - name: Cache UE Dependencies
      uses: actions/cache@v4
      with:
        path: ue\.git\ue4-gitdeps
        key: ue4-gitdeps-4.27

    # -------------------------------------------------
    # Sync UE Dependencies
    # -------------------------------------------------
    - name: Sync UE Dependencies
      shell: cmd
      run: |
        X:
        Engine\Binaries\DotNET\GitDependencies.exe ^
          --exclude=Mac --exclude=Linux --exclude=Android ^
          --exclude=IOS --exclude=TVOS --exclude=WinRT --exclude=HTML5

    # -------------------------------------------------
    # Generate Project Files
    # -------------------------------------------------
    - name: Generate Project Files
      shell: cmd
      run: |
        X:
        GenerateProjectFiles.bat

    # -------------------------------------------------
    # Prebuild AutomationTool (CRITICAL FIX)
    # -------------------------------------------------
    - name: Build AutomationTool
      shell: powershell
      run: |
        & X:\Engine\Build\BatchFiles\Build.bat `
          AutomationTool Win64 Development -NoDebugInfo
        if ($LASTEXITCODE -ne 0) { exit 1 }

    # -------------------------------------------------
    # Checkout Game Project
    # -------------------------------------------------
    - name: Checkout Game Project
      uses: actions/checkout@v4
      with:
        repository: ViteStudio-Tech/ueVite-ThirdPersonGAS-Example
        path: project
        lfs: true

    # -------------------------------------------------
    # Resolve Build Config ONCE
    # -------------------------------------------------
    - name: Resolve Build Config
      shell: powershell
      run: |
        $cfg = "${{ github.event.inputs.buildConfig }}"
        if (-not $cfg) { $cfg = "Development" }
        if ($cfg -notin @("Development","Shipping")) {
          Write-Error "Invalid config $cfg"
          exit 1
        }
        echo "BUILD_CONFIG=$cfg" >> $env:GITHUB_ENV

    # -------------------------------------------------
    # Build Game Target
    # -------------------------------------------------
    - name: Build Game
      shell: powershell
      run: |
        & X:\Engine\Build\BatchFiles\Build.bat `
          ActionRPG Win64 $env:BUILD_CONFIG `
          -Project="$env:UPROJECT" `
          -NoHotReload -NoDebugInfo
        if ($LASTEXITCODE -ne 0) { exit 1 }

    # -------------------------------------------------
    # Package (CMD-SAFE AutomationTool Invocation)
    # -------------------------------------------------
    - name: Package WindowsNoEditor
      shell: powershell
      run: |
        $cfg = $env:BUILD_CONFIG
        $uat = "$env:UE_ROOT\Build\BatchFiles\RunUAT.bat"

        & cmd.exe /c `
          "`"$uat`" BuildCookRun ^
            -project=`"$env:UPROJECT`" ^
            -noP4 ^
            -platform=Win64 ^
            -clientconfig=$cfg ^
            -cook -allmaps -stage -pak -archive ^
            -archivedirectory=`"$env:OUTPUT_DIR`""

        if ($LASTEXITCODE -ne 0) { exit 1 }

    # -------------------------------------------------
    # Upload Artifact
    # -------------------------------------------------
    - name: Upload Packaged Game
      uses: actions/upload-artifact@v4
      with:
        name: UE4-WindowsNoEditor-${{ env.BUILD_CONFIG }}
        path: project\release\**\WindowsNoEditor\**
