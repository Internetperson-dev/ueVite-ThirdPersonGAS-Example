name: UE4 Optimized Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      buildConfig:
        description: "Build Configuration"
        required: true
        default: "Development"
        type: choice
        options:
          - Development
          - Shipping

jobs:
  build:
    runs-on: windows-2019

    steps:

    # -------------------------------------------------
    # Enable Long Paths
    # -------------------------------------------------
    - name: Enable Windows long paths
      shell: powershell
      run: |
        New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" `
          -Name "LongPathsEnabled" -Value 1 -PropertyType DWORD -Force
        git config --system core.longpaths true

    # -------------------------------------------------
    # Install all VC++ Runtimes for compatablity and DirectX to maybe fix a runtime issue.
    # -------------------------------------------------
    - name: Install VC++ Runtime
      shell: powershell
      run: |
        choco install vcredist-all -y 
        choco install directx -y 

    # -------------------------------------------------
    # Checkout Engine
    # -------------------------------------------------
    - name: Checkout UE4 Engine
      uses: actions/checkout@v4
      with:
        repository: GapingPixel/UnrealEngineVite-PhysX
        path: ue
        lfs: true
        token: ${{ secrets.UE_PAT }}

    # -------------------------------------------------
    # Map to X Drive
    # -------------------------------------------------
    - name: Map UE4 to drive X
      shell: cmd
      run: |
        subst X: "%GITHUB_WORKSPACE%\ue"

    # -------------------------------------------------
    # Restore Engine Build Cache
    # -------------------------------------------------
    - name: Restore Engine Build Cache
      uses: actions/cache@v4
      with:
        path: |
          ue\Engine\Binaries
          ue\Engine\Intermediate
          ue\Engine\Saved
        key: ${{ runner.os }}-ue4-engine-4.27-${{ hashFiles('ue/Engine/Source/**', 'ue/Engine/Build/**') }}
        restore-keys: |
          ${{ runner.os }}-ue4-engine-4.27-

    # -------------------------------------------------
    # Cache UE4 Dependencies
    # -------------------------------------------------
    - name: Cache UE4 Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ue\.git\ue4-gitdeps
          ue\Engine\Binaries\ThirdParty
          ue\Engine\Source\ThirdParty
          ue\Engine\Extras
        key: ${{ runner.os }}-ue4-deps-4.27

    # -------------------------------------------------
    # Sync Dependencies
    # -------------------------------------------------
    - name: Sync UE4 Dependencies
      shell: cmd
      run: |
        cd /d X:\
        Engine\Binaries\DotNET\GitDependencies.exe ^
          --exclude=Mac ^
          --exclude=Linux ^
          --exclude=Android ^
          --exclude=IOS ^
          --exclude=TVOS ^
          --exclude=WinRT ^
          --exclude=HTML5 ^
          --threads=16

    # -------------------------------------------------
    # Generate Project Files
    # -------------------------------------------------
    - name: Generate Project Files
      shell: cmd
      run: cd /d X:\ && GenerateProjectFiles.bat

    # -------------------------------------------------
    # Checkout Game Project
    # -------------------------------------------------
    - name: Checkout Game Project
      uses: actions/checkout@v4
      with:
        repository: ViteStudio-Tech/ueVite-ThirdPersonGAS-Example
        path: project
        lfs: true

    # -------------------------------------------------
    # Cache Project Build
    # -------------------------------------------------
    - name: Cache Project Build
      uses: actions/cache@v4
      with:
        path: |
          project\Binaries
          project\Intermediate
        key: ${{ runner.os }}-project-${{ hashFiles('project/Source/**', 'project/*.uproject') }}
        restore-keys: |
          ${{ runner.os }}-project-

    # -------------------------------------------------
    # Cache DerivedDataCache
    # -------------------------------------------------
    - name: Cache DerivedDataCache
      uses: actions/cache@v4
      with:
        path: |
          ue\Engine\DerivedDataCache
          project\Saved\DerivedDataCache
        key: ${{ runner.os }}-ddc-${{ hashFiles('project/Content/**') }}
        restore-keys: |
          ${{ runner.os }}-ddc-

    # -------------------------------------------------
    # Check UE4 Editor Cache
    # -------------------------------------------------



    - name: Check if UE4Editor exists
      id: check_editor
      shell: powershell
      run: |
        if (Test-Path "X:\Engine\Binaries\Win64\UE4Editor-Cmd.exe") {
          echo "exists=true" >> $env:GITHUB_OUTPUT
        } else {
          echo "exists=false" >> $env:GITHUB_OUTPUT
        }

    # -------------------------------------------------
    # Build UE4 Editor (required for cooking)
    # -------------------------------------------------
    - name: Build UE4 Editor
      if: steps.check_editor.outputs.exists == 'false'
      shell: powershell
      run: |
        Write-Host "Building UE4Editor..."
        & "X:\Engine\Build\BatchFiles\Build.bat" `
          UE4Editor `
          Win64 `
          Development `
          -NoHotReload `
          -NoDebugInfo
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        Write-Host "UE4Editor build completed."
    # -------------------------------------------------
    # Build Game Target
    # -------------------------------------------------
    - name: Build Game Target
      shell: powershell
      run: |
        $config = "${{ github.event.inputs.buildConfig }}"
        if ([string]::IsNullOrWhiteSpace($config)) { $config = "Development" }
        $uproject = "$env:GITHUB_WORKSPACE\project\ActionRPG - Vite\ActionRPG.uproject"
        if (!(Test-Path $uproject)) { Write-Error "UPROJECT NOT FOUND!"; exit 1 }
        Write-Host "Building configuration: $config"
        & "X:\Engine\Build\BatchFiles\Build.bat" `
          ActionRPG `
          Win64 `
          $config `
          -Project="$uproject" `
          -NoHotReload `
          -NoDebugInfo
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        Write-Host "Build completed successfully."

    # -------------------------------------------------
    # Package WindowsNoEditor
    # -------------------------------------------------
    - name: Package WindowsNoEditor
      shell: powershell
      run: |
        $config = "${{ github.event.inputs.buildConfig }}"
        if ([string]::IsNullOrWhiteSpace($config)) { $config = "Development" }
        $uproject = "$env:GITHUB_WORKSPACE\project\ActionRPG - Vite\ActionRPG.uproject"
        $outputDir = "$env:GITHUB_WORKSPACE\project\release"
        Write-Host "Packaging WindowsNoEditor to $outputDir with configuration: '$config' ..."
        & "X:\Engine\Build\BatchFiles\RunUAT.bat" BuildCookRun `
          -project="$uproject" `
          -noP4 `
          -platform=Win64 `
          -game `
          -clientconfig="$config" `
          -serverconfig="$config" `
          -cook `
          -allmaps `
          -stage `
          -pak `
          -archive `
          -archivedirectory="$outputDir"
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        Write-Host "Packaging completed successfully."

    # -------------------------------------------------
    # Upload Packaged Game
    # -------------------------------------------------
    - name: Upload Packaged Game
      uses: actions/upload-artifact@v4
      with:
        name: UE4-WindowsNoEditor-${{ github.event.inputs.buildConfig }}
        path: project\release\**\WindowsNoEditor\**
