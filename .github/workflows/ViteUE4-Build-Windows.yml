name: UE4 Optimized Build (Windows)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      buildConfig:
        description: 'Build Configuration'
        required: true
        default: 'Development'
        type: choice
        options: [Development, Shipping]

jobs:
  build:
    runs-on: windows-2019
    env:
      UE_ROOT: X:\
      PROJECT_DIR: ${{ github.workspace }}\project
      UPROJECT: "${{ github.workspace }}\\project\\ActionRPG - Vite\\ActionRPG.uproject"
      OUTPUT_DIR: ${{ github.workspace }}\project\release

    steps:
      - name: Enable long paths
        run: |
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\FileSystem" /v LongPathsEnabled /t REG_DWORD /d 1 /f
          git config --system core.longpaths true

      - name: Install Unreal legacy dependencies
        run: |
          choco install directx --confirm -y
          choco install vcredist-all -y
          choco install windows-sdk-10-version-1903-all -y
          choco install dotnetfx --version=4.6.2 -y

      - name: Checkout UE4 Engine
        uses: actions/checkout@v4
        with:
          repository: GapingPixel/UnrealEngineVite-PhysX
          path: ue
          lfs: true
          token: ${{ secrets.UE_PAT }}

      - name: Map UE to X drive
        shell: cmd
        run: |
          subst X: "%GITHUB_WORKSPACE%\ue"
          
      - name: Sync UE Dependencies
        shell: cmd
        run: |
          X:
          cd \
          Engine\Binaries\DotNET\GitDependencies.exe --exclude=Mac --exclude=Linux --exclude=Android --exclude=IOS --exclude=TVOS --exclude=WinRT --exclude=HTML5

      - name: Generate Project Files
        shell: cmd
        run: |
          X:
          cd \
          GenerateProjectFiles.bat

      - name: Build Automation Tool & Core Tools
        shell: cmd
        run: |
          X:
          :: Build UAT
          "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\MSBuild\Current\Bin\MSBuild.exe" Engine\Source\Programs\AutomationTool\AutomationTool.csproj /p:Configuration=Development /p:Platform=AnyCPU
          :: Build Shader Workers (Required for RTXGI shaders)
          Engine\Build\BatchFiles\Build.bat ShaderCompileWorker Win64 Development -WaitMutex

      - name: Checkout Game Project
        uses: actions/checkout@v4
        with:
          repository: ViteStudio-Tech/ueVite-ThirdPersonGAS-Example
          path: project
          lfs: true

      - name: Resolve Build Config
        shell: powershell
        run: |
          $cfg = "${{ github.event.inputs.buildConfig }}"
          if ([string]::IsNullOrWhiteSpace($cfg)) { $cfg = "Development" }
          echo "BUILD_CONFIG=$cfg" >> $env:GITHUB_ENV

      - name: Build UE4 Editor & RTXGI Plugin
        shell: cmd
        run: |
          X:
          cd \
          :: Build Editor
          Engine\Build\BatchFiles\Build.bat UE4Editor Win64 Development -WaitMutex -NoHotReload
          :: Build the specific RTXGI module if it exists in the source
          if exist X:\Engine\Plugins\Runtime\Nvidia\RTXGI Engine\Build\BatchFiles\Build.bat RTXGI Win64 Development -WaitMutex -NoHotReload

      - name: Build Game Binaries
        shell: cmd
        run: |
          X:
          cd \
          Engine\Build\BatchFiles\Build.bat ActionRPG Win64 %BUILD_CONFIG% -Project="%UPROJECT%" -NoHotReload -NoDebugInfo

      - name: Package WindowsNoEditor
        shell: cmd
        run: |
          X:
          cd \
          Engine\Build\BatchFiles\RunUAT.bat BuildCookRun ^
            -project="%UPROJECT%" ^
            -noP4 -platform=Win64 -clientconfig=%BUILD_CONFIG% ^
            -cook -allmaps -stage -pak -archive ^
            -archivedirectory="%OUTPUT_DIR%" ^
            -unattended -nullrhi -UTF8Output -ni -nocompile

      - name: Upload Packaged Game
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: UE4-WindowsNoEditor-${{ env.BUILD_CONFIG }}
          path: project/release/WindowsNoEditor/**

      - name: Collect Logs on Failure
        if: failure()
        shell: cmd
        run: |
          subst X: "%GITHUB_WORKSPACE%\ue"
          mkdir build_logs
          dir X:\Engine\Binaries\Win64\ > build_logs\binaries_list.txt
          if exist X:\Engine\Programs\AutomationTool\Saved\Logs (xcopy /s /y X:\Engine\Programs\AutomationTool\Saved\Logs\* build_logs\)
          if exist X:\Engine\Programs\AutomationTool\Saved\Cook*.txt (xcopy /y X:\Engine\Programs\AutomationTool\Saved\Cook*.txt build_logs\)

      - name: Upload Error Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: Build-Failure-Diagnostics
          path: build_logs/
