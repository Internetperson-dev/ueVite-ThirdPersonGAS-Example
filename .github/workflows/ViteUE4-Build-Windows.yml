name: UE4 Optimized Build (Windows)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      buildConfig:
        description: 'Build Configuration'
        required: true
        default: 'Development'
        type: choice
        options: [Development, Shipping]

jobs:
  build:
    runs-on: windows-2019 # Required for older UE4 toolchains
    env:
      UE_ROOT: X:\
      PROJECT_DIR: ${{ github.workspace }}\project
      # Note the escaped quotes for the space in the folder name
      UPROJECT: "${{ github.workspace }}\\project\\ActionRPG - Vite\\ActionRPG.uproject"
      OUTPUT_DIR: ${{ github.workspace }}\project\release

    steps:
      - name: Enable long paths
        run: |
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\FileSystem" /v LongPathsEnabled /t REG_DWORD /d 1 /f
          git config --system core.longpaths true

      - name: Install Unreal legacy dependencies
        run: |
          choco install vcredist-all -y
          choco install windows-sdk-10-version-1903-all -y
          choco install dotnetfx --version=4.6.2 -y

      - name: Checkout UE4 Engine
        uses: actions/checkout@v4
        with:
          repository: GapingPixel/UnrealEngineVite-PhysX
          path: ue
          lfs: true
          token: ${{ secrets.UE_PAT }}

      - name: Map UE to X drive
        shell: cmd
        run: subst X: "%GITHUB_WORKSPACE%\ue"

      - name: Cache UE Dependencies
        uses: actions/cache@v4
        with:
          path: ue\.git\ue4-gitdeps
          key: ue4-gitdeps-4.27

      - name: Sync UE Dependencies
        shell: cmd
        run: |
          X:
          cd \
          Engine\Binaries\DotNET\GitDependencies.exe --exclude=Mac --exclude=Linux --exclude=Android --exclude=IOS --exclude=TVOS --exclude=WinRT --exclude=HTML5

      - name: Generate Project Files
        shell: cmd
        run: |
          X:
          cd \
          GenerateProjectFiles.bat

      - name: Checkout Game Project
        uses: actions/checkout@v4
        with:
          repository: ViteStudio-Tech/ueVite-ThirdPersonGAS-Example
          path: project
          lfs: true

      - name: Resolve Build Config
        shell: powershell
        run: |
          $cfg = "${{ github.event.inputs.buildConfig }}"
          if ([string]::IsNullOrWhiteSpace($cfg)) { $cfg = "Development" }
          echo "BUILD_CONFIG=$cfg" >> $env:GITHUB_ENV

      - name: Build Game
        shell: cmd
        run: |
          X:
          cd \
          Engine\Build\BatchFiles\Build.bat ActionRPG Win64 %BUILD_CONFIG% -Project="%UPROJECT%" -NoHotReload -NoDebugInfo

      - name: Package WindowsNoEditor
        shell: cmd
        run: |
          X:
          cd \
          Engine\Build\BatchFiles\RunUAT.bat BuildCookRun ^
            -project="%UPROJECT%" ^
            -noP4 -platform=Win64 -clientconfig=%BUILD_CONFIG% ^
            -cook -allmaps -stage -pak -archive ^
            -archivedirectory="%OUTPUT_DIR%"

      - name: Upload Packaged Game
        uses: actions/upload-artifact@v4
        with:
          name: UE4-WindowsNoEditor-${{ env.BUILD_CONFIG }}
          path: project/release/WindowsNoEditor/**
