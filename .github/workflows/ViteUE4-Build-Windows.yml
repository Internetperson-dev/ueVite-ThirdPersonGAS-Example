name: UE4 Optimized Build (Windows)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      buildConfig:
        description: 'Build Configuration'
        required: true
        default: 'Development'
        type: choice
        options: [Development, Shipping]

jobs:
  build:
    runs-on: windows-2019
    env:
      UE_ROOT: X:\
      PROJECT_DIR: ${{ github.workspace }}\project
      UPROJECT: "${{ github.workspace }}\\project\\ActionRPG - Vite\\ActionRPG.uproject"
      OUTPUT_DIR: ${{ github.workspace }}\project\release

    steps:
      - name: Enable long paths
        run: |
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\FileSystem" /v LongPathsEnabled /t REG_DWORD /d 1 /f
          git config --system core.longpaths true

      - name: Checkout UE4 Engine
        uses: actions/checkout@v4
        with:
          repository: GapingPixel/UnrealEngineVite-PhysX
          path: ue
          lfs: true
          token: ${{ secrets.UE_PAT }}

      - name: Map UE to X drive
        shell: cmd
        run: |
          subst X: "%GITHUB_WORKSPACE%\ue"
          
      - name: Setup UBT BuildConfiguration
        shell: powershell
        run: |
          $xmlPath = "$env:AppData\Unreal Engine\UnrealBuildTool\BuildConfiguration.xml"
          $directory = [System.IO.Path]::GetDirectoryName($xmlPath)
          if (!(Test-Path $directory)) { New-Item -ItemType Directory -Force -Path $directory }
          $xmlContent = @"
          <?xml version="1.0" encoding="utf-8" ?>
          <Configuration xmlns="https://www.unrealengine.com/BuildConfiguration">
              <WindowsPlatform>
                  <WindowsSdkVersion>10.0.19041.0</WindowsSdkVersion>
              </WindowsPlatform>
          </Configuration>
          "@
          Set-Content -Path $xmlPath -Value $xmlContent

      - name: Sync Dependencies
        shell: cmd
        run: |
          X:
          echo N | Engine\Binaries\DotNET\GitDependencies.exe --exclude=Mac --exclude=Linux --exclude=Android --exclude=IOS --exclude=TVOS

      - name: Generate Project Files
        shell: cmd
        run: |
          X:
          GenerateProjectFiles.bat

      - name: Build Automation Tool & Workers
        shell: cmd
        run: |
          X:
          "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\MSBuild\Current\Bin\MSBuild.exe" Engine\Source\Programs\AutomationTool\AutomationTool.csproj /p:Configuration=Development /p:Platform=AnyCPU
          Engine\Build\BatchFiles\Build.bat ShaderCompileWorker Win64 Development -WaitMutex
          Engine\Build\BatchFiles\Build.bat UnrealPak Win64 Development -WaitMutex

      - name: Checkout Game Project
        uses: actions/checkout@v4
        with:
          repository: ViteStudio-Tech/ueVite-ThirdPersonGAS-Example
          path: project
          lfs: true

      - name: Build Editor with RTXGI
        shell: cmd
        run: |
          X:
          :: We build the Editor target. Because RTXGI is an Engine plugin, 
          :: UBT will discover the source and compile it into the Engine's binary folder.
          Engine\Build\BatchFiles\Build.bat UE4Editor Win64 Development -Project="%UPROJECT%" -WaitMutex -NoHotReload

      - name: Build Game Binaries
        shell: cmd
        run: |
          X:
          Engine\Build\BatchFiles\Build.bat ActionRPG Win64 ${{ github.event.inputs.buildConfig || 'Development' }} -Project="%UPROJECT%" -WaitMutex -NoHotReload

      - name: Package Project
        shell: cmd
        run: |
          X:
          :: -nullrhi is essential here because your fork has RT enabled by default.
          :: Without a GPU, the Cooker will crash unless we use the Null RHI.
          Engine\Build\BatchFiles\RunUAT.bat BuildCookRun ^
            -project="%UPROJECT%" ^
            -noP4 -platform=Win64 -clientconfig=${{ github.event.inputs.buildConfig || 'Development' }} ^
            -cook -allmaps -stage -pak -archive ^
            -archivedirectory="%OUTPUT_DIR%" ^
            -unattended -nullrhi -ni -nocompileeditor

      - name: Upload Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ActionRPG-Vite-Build
          path: project/release/WindowsNoEditor/**

      - name: Diagnostic Logs
        if: failure()
        shell: cmd
        run: |
          subst X: "%GITHUB_WORKSPACE%\ue"
          mkdir build_logs
          dir X:\Engine\Binaries\Win64\UE4Editor-RTXGI* /s > build_logs\rtxgi_dll_location.txt
          xcopy /s /y X:\Engine\Programs\AutomationTool\Saved\Logs\* build_logs\
          if exist X:\Engine\Programs\AutomationTool\Saved\Cook*.txt xcopy /y X:\Engine\Programs\AutomationTool\Saved\Cook*.txt build_logs\

      - name: Upload Error Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: Failure-Logs
          path: build_logs/
