name: UE4 Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2019

    steps:

    # -------------------------------------------------
    # Enable Windows + Git long paths
    # -------------------------------------------------
    - name: Enable Windows long paths
      shell: powershell
      run: |
        New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" `
          -Name "LongPathsEnabled" -Value 1 -PropertyType DWORD -Force

    - name: Enable git long paths
      shell: powershell
      run: git config --system core.longpaths true


    # -------------------------------------------------
    # Checkout UE4 Source
    # -------------------------------------------------
    - name: Checkout UE4
      uses: actions/checkout@v4
      with:
        repository: AlexMercer-MA/UnrealEngine-4.27
        path: a
        lfs: true
        fetch-depth: 1


    # -------------------------------------------------
    # Map UE4 folder to drive X:
    # -------------------------------------------------
    - name: Map UE4 to drive X
      shell: cmd
      run: |
        subst X: "%GITHUB_WORKSPACE%\a"


    # -------------------------------------------------
    # Cache UE4 GitDependencies
    # -------------------------------------------------
    - name: Cache UE4 Dependencies
      uses: actions/cache@v4
      with:
        path: a\.git\ue4-gitdeps
        key: ue4-gitdeps-4.27


    # -------------------------------------------------
    # Sync UE4 Dependencies
    # -------------------------------------------------
    - name: Sync UE4 Dependencies
      shell: cmd
      run: |
        cd /d X:\
        Engine\Binaries\DotNET\GitDependencies.exe ^
          --exclude=Mac ^
          --exclude=Linux ^
          --exclude=Android ^
          --exclude=IOS ^
          --exclude=TVOS ^
          --exclude=WinRT ^
          --exclude=HTML5 ^
          --threads=16


    # -------------------------------------------------
    # Generate Project Files
    # -------------------------------------------------
    - name: Generate Project Files
      shell: cmd
      run: |
        cd /d X:\
        GenerateProjectFiles.bat


    # -------------------------------------------------
    # Checkout Your Game Project
    # -------------------------------------------------
    - name: Checkout Project
      uses: actions/checkout@v4
      with:
        repository: ViteStudio-Tech/ueVite-ThirdPersonGAS-Example
        path: p
        lfs: true


    # -------------------------------------------------
    # Scan .uproject for enabled plugins
    # -------------------------------------------------
    - name: Get enabled plugins
      shell: powershell
      run: |
        $uproject = "$env:GITHUB_WORKSPACE\p\ActionRPG - Vite\ActionRPG.uproject"
        Write-Host "Scanning $uproject for enabled plugins..."

        if (!(Test-Path $uproject)) {
            Write-Error "UPROJECT NOT FOUND!"
            exit 1
        }

        $json = Get-Content $uproject | ConvertFrom-Json
        $enabledPlugins = @()

        foreach ($plugin in $json.Plugins) {

            if ($plugin.Enabled -eq $true) {

                $enginePath  = "X:\Engine\Plugins\$($plugin.Name)"
                $projectPath = "$env:GITHUB_WORKSPACE\p\Plugins\$($plugin.Name)"

                if ((Test-Path $enginePath) -or (Test-Path $projectPath)) {
                    $enabledPlugins += "-Plugin=`"$($plugin.Name)`""
                }
                else {
                    Write-Host "Skipping missing plugin: $($plugin.Name)"
                }
            }
        }

        $pluginArgs = $enabledPlugins -join " "
        Write-Host "Final plugin list: $pluginArgs"

        Set-Content "$env:GITHUB_WORKSPACE\plugin_args.txt" $pluginArgs


    # -------------------------------------------------
    # Build UE4Editor (minimal + required plugins)
    # -------------------------------------------------
    - name: Build UE4Editor
      shell: powershell
      run: |
        $pluginArgs = Get-Content "$env:GITHUB_WORKSPACE\plugin_args.txt"
        Write-Host "Building UE4Editor with plugins: $pluginArgs"

        & "X:\Engine\Build\BatchFiles\Build.bat" `
          UE4Editor `
          Win64 `
          Development `
          $pluginArgs `
          -NoDebugInfo `
          -NoHotReload

        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }


    # -------------------------------------------------
    # Build Game Project
    # -------------------------------------------------
    - name: Build Project
      shell: powershell
      run: |
        $pluginArgs = Get-Content "$env:GITHUB_WORKSPACE\plugin_args.txt"
        $uproject = "$env:GITHUB_WORKSPACE\p\ActionRPG - Vite\ActionRPG.uproject"

        Write-Host "Building project with plugins: $pluginArgs"

        & "X:\Engine\Build\BatchFiles\Build.bat" `
          ActionRPG `
          Win64 `
          Development `
          -Project="$uproject" `
          $pluginArgs `
          -NoDebugInfo `
          -NoHotReload

        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
