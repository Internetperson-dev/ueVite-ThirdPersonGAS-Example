name: UE4 Minimal Engine + Project Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    env:
      UE4_PATH: ${{ github.workspace }}\ue4
      PROJECT_PATH: ${{ github.workspace }}\project

    steps:

    # -------------------------------------------------
    # 1️⃣ Enable Windows + Git Long Paths
    # -------------------------------------------------
    - name: Enable Windows long paths
      shell: powershell
      run: |
        New-ItemProperty `
          -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" `
          -Name "LongPathsEnabled" `
          -Value 1 `
          -PropertyType DWORD `
          -Force

    - name: Enable git long paths
      run: git config --system core.longpaths true

    # -------------------------------------------------
    # 2️⃣ Free Disk Space (Safe Deletions Only)
    # -------------------------------------------------
    - name: Free disk space
      shell: cmd
      run: |
        echo Freeing disk space...
        rd /s /q "C:\Program Files (x86)\Microsoft Visual Studio\2022\Enterprise" 2>nul
        rd /s /q "C:\ProgramData\Chocolatey" 2>nul
        del /f /s /q C:\*.tmp 2>nul

    # -------------------------------------------------
    # 3️⃣ Checkout UE4 Source (SHORT PATH)
    # -------------------------------------------------
    - name: Checkout UE4.27 Source
      uses: actions/checkout@v4
      with:
        repository: AlexMercer-MA/UnrealEngine-4.27
        path: ue4
        lfs: true

    # -------------------------------------------------
    # 4️⃣ Minimal Setup (Win64 only)
    # -------------------------------------------------
    - name: Setup UE4 (Win64 only)
      shell: cmd
      run: |
        cd %UE4_PATH%
        Setup.bat -exclude=Mac -exclude=Linux -exclude=Android -exclude=IOS -exclude=TVOS -exclude=WinRT -exclude=HTML5

    # -------------------------------------------------
    # 5️⃣ Generate Project Files
    # -------------------------------------------------
    - name: Generate Project Files
      shell: cmd
      run: |
        cd %UE4_PATH%
        GenerateProjectFiles.bat

    # -------------------------------------------------
    # 6️⃣ Build Minimal Engine Target (NO EDITOR)
    # -------------------------------------------------
    - name: Build UE4Game (Development Win64)
      shell: cmd
      run: |
        cd %UE4_PATH%
        Engine\Build\BatchFiles\Build.bat UE4Game Win64 Development -NoDebugInfo -NoHotReload

    # -------------------------------------------------
    # 7️⃣ Checkout Your Project (SHORT PATH)
    # -------------------------------------------------
    - name: Checkout Project
      uses: actions/checkout@v4
      with:
        repository: ViteStudio-Tech/ueVite-ThirdPersonGAS-Example
        path: project
        lfs: true

    # -------------------------------------------------
    # 8️⃣ Build Project (Game Target Only)
    # -------------------------------------------------
    - name: Build ActionRPG Game Target
      shell: cmd
      run: |
        "%UE4_PATH%\Engine\Build\BatchFiles\Build.bat" ActionRPG Win64 Development ^
        -Project="%PROJECT_PATH%\ActionRPG - Vite\ActionRPG.uproject" ^
        -NoDebugInfo -NoHotReload
